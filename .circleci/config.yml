# Python CircleCI 2.0 configuration file
# vi: et:ts=2:sw=2
#
# Check https://circleci.com/docs/2.0/language-python/ for more details
#
version: 2
jobs:
  build:
    docker:
      - image: circleci/python:3.4.9-jessie
    working_directory: ~/python-mbedtls
    steps:
      - checkout
      - run:
          name: install pyenv
          command: |
            git clone https://github.com/pyenv/pyenv.git $HOME/python-mbedtls/.pyenv
            cat << 'EOF' >> $BASH_ENV
            export PYENV_ROOT="$HOME/python-mbedtls/.pyenv"
            export PATH="$PYENV_ROOT/bin:$PATH"
            EOF

      - restore_cache:
          keys:
            - py27-v2-{{ arch }}-2.7.15
      - run:
          name: install python 2.7
          command: |
            if [ ! -d ".pyenv/versions/2.7.15" ]; then
              eval "$(pyenv init -)"
              pyenv install 2.7.15
            fi
      - save_cache:
          key: py27-v2-{{ arch }}-2.7.15
          paths:
            - .pyenv/versions/2.7.15

      - restore_cache:
          keys:
            - py34-v2-{{ arch }}-3.4.9
      - run:
          name: install python 3.4
          command: |
            if [ ! -d ".pyenv/versions/3.4.9" ]; then
              eval "$(pyenv init -)"
              pyenv install 3.4.9
            fi
      - save_cache:
          key: py34-v2-{{ arch }}-3.4.9
          paths:
            - .pyenv/versions/3.4.9

      - restore_cache:
          keys:
            - py35-v2-{{ arch }}-3.5.6
      - run:
          name: install python 3.5
          command: |
            if [ ! -d ".pyenv/versions/3.5.6" ]; then
              eval "$(pyenv init -)"
              pyenv install 3.5.6
            fi
      - save_cache:
          key: py35-v2-{{ arch }}-3.5.6
          paths:
            - .pyenv/versions/3.5.6

      - restore_cache:
          keys:
            - py36-v2-{{ arch }}-3.6.6
      - run:
          name: install python 3.6
          command: |
            if [ ! -d ".pyenv/versions/3.6.6" ]; then
              eval "$(pyenv init -)"
              pyenv install 3.6.6
            fi
      - save_cache:
          key: py36-v2-{{ arch }}-3.6.6
          paths:
            - .pyenv/versions/3.6.6

      - run:
          name: install mbedtls
          command: |
            VERSION=2.16.0
            sudo apt-get install cmake
            echo 'export MBEDTLS_CHECK_PARAMS=""' >> $BASH_ENV
            export CFLAGS="-DMBEDTLS_CHECK_PARAMS"
            sudo --preserve-env ./scripts/install-mbedtls.sh $VERSION
            gcc -c -o libpf.so -fPIC extras/param_failed.c
            sudo cp libpf.so /usr/local/lib

      - run:
          name: Create environment
          command: python -m venv venv

      - run:
          name: run tests
          command: |
            eval "$(pyenv init -)"
            pyenv shell 2.7.15 3.4.9 3.5.6 3.6.6
            . venv/bin/activate
            pip install detox
            detox -e py27 -e py34 -e py35 -e py36

      - run:
          name: save logs
          command: |
            mkdir -p out/log
            cp .tox/*/log/py*.log out/log || true
          when: on_fail

      - store_artifacts:
          path: out
          destination: artifacts
